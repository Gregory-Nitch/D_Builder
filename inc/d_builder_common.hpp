/***********************************************************************************************************************
 * @date 2025-12-14
 * @author Gregory Nitch
 *
 * @brief Common header file for the D_Builder application, here common macros, definitions and app global variables
 * are defined.
 **********************************************************************************************************************/

#pragma once

/*
========================================================================================================================
- - System Includes - -
========================================================================================================================
*/

#include <cstdint>
#include <memory>
#include <vector>
#include <unordered_map>
#include <string>
#include <format>

/*
========================================================================================================================
- - Forward Delcarations - -
========================================================================================================================
*/

// Forward declarations to break circular dependencies:
class D_Tile;
class D_Map;

/*
========================================================================================================================
- - Macros - -
========================================================================================================================
*/

/***********************************************************************************************************************
 * @brief CLI generation string to match to cli params.
 **********************************************************************************************************************/
#define GENERATE_IMG_CLI_COMMAND "generate"

/***********************************************************************************************************************
 * @brief Default image directory path, will contain the input, loaded and output directories.
 **********************************************************************************************************************/
#define DEFAULT_BASE_IMG_PATH "./imgs/"

/***********************************************************************************************************************
 * @brief Default input image path for the application, tiles are expected to be placed in this directory.
 **********************************************************************************************************************/
#define DEFAULT_INPUT_IMG_PATH "./imgs/input/"

/***********************************************************************************************************************
 * @brief Default D_Tile loaded path for the application, tiles are expected to move and save here on application start
 * and when new tiles have been generated.
 **********************************************************************************************************************/
#define DEFAULT_SECTION_IMG_LOADED_PATH "./imgs/loaded/"

/***********************************************************************************************************************
 * @brief Default D_Map output path for the application, maps will be saved to this directory when requested.
 **********************************************************************************************************************/
#define DEFAULT_OUTPUT_IMG_PATH "./imgs/output/"

/***********************************************************************************************************************
 * @brief Default D_Map output path for the application, maps will be saved to this directory when requested.
 **********************************************************************************************************************/
#define DEFAULT_TEST_OUTPUT_IMG_PATH "./imgs/TEST_output/"

/***********************************************************************************************************************
 * @brief Standard output quality of images when saving.
 **********************************************************************************************************************/
#define DEFAULT_OUTPUT_QUALITY (100)

/***********************************************************************************************************************
 * @brief The amount of times to test permutations for testing map generation.
 **********************************************************************************************************************/
#define TEST_ITERATION_COUNT (100)

/***********************************************************************************************************************
 * @brief Produces a std::format from the passed error message. Adds filename, function name, line and an ERR
 * identifier.
 * @param msg Message to be formated into the string.
 **********************************************************************************************************************/
#define ERR_FORMAT(msg) \
    std::format("ERR:{}:{}:{}: {}", __FILE__, __func__, __LINE__, msg)

/***********************************************************************************************************************
 * @brief Prints the given message to std::cout along with filename, function name and line.
 * @param msg Message to be logged.
 **********************************************************************************************************************/
#define LOG_DEBUG(msg) \
    std::cout << "INF:" << __FILE__ << ":" << __func__ << ":" << __LINE__ << ":" << msg << std::endl

/*
========================================================================================================================
- - App Globals - -
========================================================================================================================
*/

/***********************************************************************************************************************
 * @brief Global map of all D_Tiles loaded by the program, normally initialized at application start.
 **********************************************************************************************************************/
extern std::unordered_map<uint64_t, std::shared_ptr<D_Tile>> Tile_Map;

/***********************************************************************************************************************
 * @brief Global map of all entrance D_Tiles loaded by the program, normally initialized at application start. These are
 * shared with the Tile_Map global variable.
 **********************************************************************************************************************/
extern std::unordered_map<uint64_t, std::shared_ptr<D_Tile>> Entrance_Map;

/***********************************************************************************************************************
 * @brief Global map of all exit D_Tiles loaded by the program, normally initialized at application start. These are
 * shared with the Tile_Map global variable.
 **********************************************************************************************************************/
extern std::unordered_map<uint64_t, std::shared_ptr<D_Tile>> Exit_Map;

/***********************************************************************************************************************
 * @brief Global empty tile shared pointer.
 **********************************************************************************************************************/
extern std::shared_ptr<D_Tile> Empty_Tile;

/***********************************************************************************************************************
 * @brief Global dungeon map for the application, will be used to keep track of what should be displayed in the GUI.
 **********************************************************************************************************************/
extern std::unique_ptr<D_Map> Dungeon_Map;

/***********************************************************************************************************************
 * @brief Variable to check against CLI param to denote that the application should generate tiles on start.
 **********************************************************************************************************************/
extern std::string Gen_Flag;

/*
========================================================================================================================
- - Global Functions - -
========================================================================================================================
*/

void init_img_dirs(void);

/***********************************************************************************************************************
 * @brief Helper function to reverse 8 bits.
 *
 * @param[in] n bits as a uint8.
 *
 * @retval uint8_t the reversed representation.
 **********************************************************************************************************************/
inline uint8_t reverse_8bits(uint8_t n)
{
    n = ((n >> 1) & 0x55) | ((n << 1) & 0xAA);
    n = ((n >> 2) & 0x33) | ((n << 2) & 0xCC);
    n = ((n >> 4) & 0x0F) | ((n << 4) & 0xF0);
    return n;
}
